<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Message Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2 {
            color: #333;
        }
        .container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        #message {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            min-height: 100px;
        }
        .hidden {
            display: none;
        }
        .error {
            color: red;
            margin-top: 5px;
        }
        .info {
            background-color: #e7f3fe;
            border-left: 6px solid #2196F3;
            margin-bottom: 15px;
            padding: 10px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>Secure Message Viewer</h1>
    
    <div class="container">
        <div class="info">
            <p>Select an event, then enter your name and password word to view your message.</p>
        </div>
        
        <div class="form-group">
            <label for="eventSelect">Select Event:</label>
            <select id="eventSelect">
                <option value="">-- Select Event --</option>
            </select>
        </div>
        
        <div id="accessForm" class="hidden">
            <div class="form-group">
                <label for="name">Name:</label>
                <input type="text" id="name" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label for="password">Password Word:</label>
                <input type="password" id="password" placeholder="Enter the password word">
            </div>
            <button id="viewBtn" onclick="decryptMessage()">View Message</button>
            <span id="loadingIndicator" class="loading hidden"></span>
            <p id="errorMsg" class="error hidden"></p>
        </div>
        
        <div id="messageContainer" class="hidden">
            <h3>Your Message:</h3>
            <div id="message"></div>
        </div>
    </div>

    <script>
        // Simulated events database - in a real implementation, these would be loaded from JSON files
        const eventsDB = {
            "company_retreat_2025": {
                "title": "Company Retreat 2025",
                "messages": [
                    {
                        "recipient": "john",
                        "salt": "fda3b282a8c745e8a5d4e49be9454539",
                        "iv": "9dd8fd58fef22db0a46b127e70b5c15c",
                        "encryptedMessage": "1ec95c20bedd2a9ad5efd0987cd6bea9af6edbc2e2f4c9b51bce7e05fbd48da9d0f75cce56d55ae4e4f45c9d5cca4ea9b9a74ddf9d14ec77"
                    },
                    {
                        "recipient": "sarah",
                        "salt": "24a456e7890b1c2d3e4f56789a0b1c2d",
                        "iv": "a1b2c3d4e5f67890a1b2c3d4e5f67890",
                        "encryptedMessage": "a3df456c78901e2f3a4b56c78d9e0f12a3b45c6d7e8f90a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0"
                    },
                    {
                        "recipient": "michael",
                        "salt": "3a4b5c6d7e8f90a1b2c3d4e5f6a7b8c9",
                        "iv": "d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6",
                        "encryptedMessage": "f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5"
                    }
                ]
            },
            "team_assignments_q2": {
                "title": "Team Assignments Q2",
                "messages": [
                    {
                        "recipient": "emma",
                        "salt": "a1b2c3d4e5f67890a1b2c3d4e5f67890",
                        "iv": "f1e2d3c4b5a69870f1e2d3c4b5a69870",
                        "encryptedMessage": "e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6"
                    },
                    {
                        "recipient": "david",
                        "salt": "f1e2d3c4b5a69870f1e2d3c4b5a69870",
                        "iv": "b5a4c3d2e1f09876b5a4c3d2e1f09876",
                        "encryptedMessage": "1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2"
                    },
                    {
                        "recipient": "lisa",
                        "salt": "5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d",
                        "iv": "d9c8b7a6f5e4d3c2b1a0f9e8d7c6b5a4",
                        "encryptedMessage": "6f7e8d9c0b1a2f3e4d5c6b7a8f9e0d1c2b3a4f5e6d7c8b9a0f1e2d3c4b5a6f7e8d9c0b1a2f3e4d5c6b7a8f9e0d1c2b3a4f5e6d7"
                    }
                ]
            },
            "holiday_party_details": {
                "title": "Holiday Party Details",
                "messages": [
                    {
                        "recipient": "robert",
                        "salt": "2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f",
                        "iv": "8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f",
                        "encryptedMessage": "9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0"
                    },
                    {
                        "recipient": "jennifer",
                        "salt": "8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d",
                        "iv": "4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b",
                        "encryptedMessage": "0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1"
                    },
                    {
                        "recipient": "william",
                        "salt": "e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6",
                        "iv": "0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d",
                        "encryptedMessage": "7f8e9d0c1b2a3f4e5d6c7b8a9f0e1d2c3b4a5f6e7d8c9b0a1f2e3d4c5b6a7f8e9d0c1b2a3f4e5d6c7b8a9f0e1d2c3b4a5f6e7d8"
                    }
                ]
            }
        };

        // Function to convert hex string to Uint8Array
        function hexToBytes(hex) {
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < hex.length; i += 2) {
                bytes[i / 2] = parseInt(hex.substring(i, i + 2), 16);
            }
            return bytes;
        }

        // Function to convert Uint8Array to hex string
        function bytesToHex(bytes) {
            return Array.from(bytes)
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // Function to convert string to Uint8Array
        function stringToBytes(str) {
            return new TextEncoder().encode(str);
        }

        // Function to convert Uint8Array to string
        function bytesToString(bytes) {
            return new TextDecoder().decode(bytes);
        }

        // Function to derive key from password and salt
        async function deriveKeyFromPassword(password, salt) {
            const encoder = new TextEncoder();
            const passwordData = encoder.encode(password);
            const saltData = hexToBytes(salt);
            
            // Import the password as a key
            const baseKey = await window.crypto.subtle.importKey(
                "raw",
                passwordData,
                { name: "PBKDF2" },
                false,
                ["deriveKey"]
            );
            
            // Derive a key using PBKDF2
            return window.crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: saltData,
                    iterations: 100000,
                    hash: "SHA-256"
                },
                baseKey,
                { name: "AES-GCM", length: 256 },
                false,
                ["encrypt", "decrypt"]
            );
        }

        // Load events into the dropdown
        window.onload = function() {
            const eventSelect = document.getElementById("eventSelect");
            
            // Clear existing options except the first one
            while (eventSelect.options.length > 1) {
                eventSelect.remove(1);
            }
            
            // Add available events
            for (const eventId in eventsDB) {
                const option = document.createElement("option");
                option.value = eventId;
                option.textContent = eventsDB[eventId].title;
                eventSelect.appendChild(option);
            }
            
            // Event listener for event selection
            eventSelect.addEventListener("change", function() {
                const accessForm = document.getElementById("accessForm");
                const messageContainer = document.getElementById("messageContainer");
                const errorMsg = document.getElementById("errorMsg");
                
                if (this.value) {
                    accessForm.classList.remove("hidden");
                    messageContainer.classList.add("hidden");
                    errorMsg.classList.add("hidden");
                    
                    // Clear previous inputs
                    document.getElementById("name").value = "";
                    document.getElementById("password").value = "";
                    document.getElementById("message").textContent = "";
                } else {
                    accessForm.classList.add("hidden");
                    messageContainer.classList.add("hidden");
                }
            });
        };

        // Function to decrypt message
        async function decryptMessage() {
            const eventId = document.getElementById("eventSelect").value;
            const name = document.getElementById("name").value.toLowerCase().trim();
            const password = document.getElementById("password").value;
            const errorMsg = document.getElementById("errorMsg");
            const messageContainer = document.getElementById("messageContainer");
            const loadingIndicator = document.getElementById("loadingIndicator");
            const viewBtn = document.getElementById("viewBtn");
            
            if (!eventId || !name || !password) {
                errorMsg.textContent = "Please fill in all fields";
                errorMsg.classList.remove("hidden");
                return;
            }
            
            const eventData = eventsDB[eventId];
            
            if (!eventData) {
                errorMsg.textContent = "Event not found";
                errorMsg.classList.remove("hidden");
                return;
            }
            
            // Find the message for this recipient
            const messageData = eventData.messages.find(msg => msg.recipient === name);
            
            if (!messageData) {
                errorMsg.textContent = "No message found for this name in this event";
                errorMsg.classList.remove("hidden");
                return;
            }
            
            try {
                // Show loading indicator and disable button
                loadingIndicator.classList.remove("hidden");
                viewBtn.disabled = true;
                errorMsg.classList.add("hidden");
                
                // Create key from name + password
                const combinedPassword = name + password;
                
                // Derive a cryptographic key
                const key = await deriveKeyFromPassword(combinedPassword, messageData.salt);
                
                // Convert IV and ciphertext from hex
                const iv = hexToBytes(messageData.iv);
                const ciphertext = hexToBytes(messageData.encryptedMessage);
                
                // Decrypt the message
                const decryptedBuffer = await window.crypto.subtle.decrypt(
                    {
                        name: "AES-GCM",
                        iv: iv
                    },
                    key,
                    ciphertext
                );
                
                // Convert buffer to string
                const decryptedMessage = bytesToString(new Uint8Array(decryptedBuffer));
                
                // Display the decrypted message
                document.getElementById("message").textContent = decryptedMessage;
                messageContainer.classList.remove("hidden");
            } catch (error) {
                console.error("Decryption error:", error);
                errorMsg.textContent = "Incorrect password or decryption error";
                errorMsg.classList.remove("hidden");
                messageContainer.classList.add("hidden");
            } finally {
                // Hide loading indicator and enable button
                loadingIndicator.classList.add("hidden");
                viewBtn.disabled = false;
            }
        }

        // FOR ADMINISTRATORS: Function to encrypt a message (for creating event files)
        async function encryptMessage(name, password, message) {
            try {
                // Generate random salt and IV
                const salt = bytesToHex(window.crypto.getRandomValues(new Uint8Array(16)));
                const iv = bytesToHex(window.crypto.getRandomValues(new Uint8Array(16)));
                
                // Combine name and password
                const combinedPassword = name.toLowerCase() + password;
                
                // Derive a key
                const key = await deriveKeyFromPassword(combinedPassword, salt);
                
                // Encrypt the message
                const messageData = stringToBytes(message);
                const encryptedBuffer = await window.crypto.subtle.encrypt(
                    {
                        name: "AES-GCM",
                        iv: hexToBytes(iv)
                    },
                    key,
                    messageData
                );
                
                // Convert encrypted data to hex string
                const encryptedMessage = bytesToHex(new Uint8Array(encryptedBuffer));
                
                // Return encrypted data and parameters needed for decryption
                return {
                    recipient: name.toLowerCase(),
                    salt: salt,
                    iv: iv,
                    encryptedMessage: encryptedMessage
                };
            } catch (error) {
                console.error("Encryption error:", error);
                throw error;
            }
        }

        // Example of how to use the encrypt function:
        /*
        async function createTestData() {
            try {
                const encryptedData = await encryptMessage("john", "sunshine", "Hello John! Your secret cabin assignment is Cabin #12");
                console.log(encryptedData);
                // This would output an object that could be saved to a JSON file
            } catch (error) {
                console.error("Error creating test data:", error);
            }
        }
        */
    </script>
</body>
</html>
